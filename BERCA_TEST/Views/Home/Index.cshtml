
<!-- Style to set the size of checkbox -->
<style>
    input.larger-checkbox {
        width: 40px;
        height: 40px;
    }
</style>



<div class="row">
    <div class="col-md-12">
        <!-- BEGIN PROFILE CONTENT -->
        <div class="profile-content">
            <div class="row">
                <div class="col-md-12">
                    <div class="portlet light bordered">
                        <div class="portlet-title tabbable-line">
                            <div class="caption caption-md">
                                <i class="icon-globe theme-font hide"></i>
                                <span class="caption-subject bold uppercase font-dark">Data Invoice</span>
                            </div>
                            <div class="actions">
                                <div class="btn-group-devided" data-toggle="buttons">
                                    <button style="margin-right: 10px;" id="btn-add-invoice" class="btn bg-red-thunderbird bg-font-red-thunderbird">
                                        <i class="fa fa-plus"></i> Add
                                    </button>
                                    <button style="margin-right: 10px;" id="btn-add-ethnic-modal" class="btn bg-red-thunderbird bg-font-red-thunderbird">
                                        <i class="fa fa-report"></i> Report
                                    </button>
                                </div>
                            </div>
                        </div>
                        <div class="portlet-body">
                            <table class="table table-striped table-hover table-bordered" id="table_invoice">
                                <thead>
                                    <tr class="bg-red-thunderbird bg-font-red-thunderbird">
                                        <th> Action </th>
                                        <th> Invoice No </th>
                                        <th> Customer Name </th>
                                        <th> Invoice Date </th>
                                        <th> Due Date </th>
                                        <th> Currency </th>
                                        <th> Invoice Ammound (IDR) </th>
                                        <th> Open Ammound </th>
                                        <th> Remark </th>
                                    </tr>
                                </thead>
                                <tbody></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- END PROFILE CONTENT -->
    </div>
</div>

<div id="modal-invoice" class="modal fade" data-width="760" data-backdrop="static" tabindex="-1">
    <div class="modal-header bg-red-thunderbird bg-font-red-thunderbird">
        <button type="button" class="close cancel" data-dismiss="modal" aria-hidden="true"></button>
        <h4 class="modal-title">DATA INVOICE</h4>
    </div>
    <form action="#" id="form_invoice" class="form-horizontal">
        <input type="hidden" id="txtDueDate" />
        <div class="form-body">
            <div class="modal-body">
                <input type="hidden" id="txtEthnicId" class="form-control" />
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Nama Customer</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <select id="txtCustomerName" name="customer-name" class="select2me form-control show-tick">
                                <option value="">Customer ID - Customer Name</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Invoice No</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <input type="text" id="txtInvoiceNo" placeholder="Invoice No" maxlength="100" name="ethnic" class="form-control" disabled="disabled" />
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Invoice Date</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <input type="text" id="txtInvoiceDate" placeholder="Invoice Date" maxlength="100" name="ethnic" class="form-control" disabled="disabled" />
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Currency</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <select id="txtCurrency" name="customer-name" class="select2me form-control show-tick">
                                <option value="">Customer ID - Customer Name</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Rate</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <input type="text" id="txtRate" placeholder="Rate" maxlength="100" name="ethnic" class="form-control" disabled="disabled" />
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Invoice Ammount</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <input type="text" id="txtInvoiceAmmount" placeholder="Invoice Ammount" maxlength="100" name="ethnic" class="form-control number-only" />
                        </div>
                    </div>
                </div>
                <div class="row" style="margin-bottom: -5px;">
                    <div class="form-group">
                        <label class="control-label col-md-3">Remark</label>
                        <div class="col-md-9" style="padding-right: 40px; !important;">
                            <input type="text" id="txtRemark" placeholder="Remark" maxlength="255" name="ethnic" class="form-control" />
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" data-dismiss="modal" class="btn cancel btn-outline dark">Batal</button>
                <button type="button" class="btn red-thunderbird" id="btn-submit-invoice">Submit</button>
            </div>
        </div>
    </form>
</div>

<script src="~/assets/global/plugins/jquery.min.js" type="text/javascript"></script>
<script src="~/assets/pages/scripts/form-validation-master.js" type="text/javascript"></script>

<script>
    $(document).ready(function () {

        /* INIT TABLE INVOICE */
        function initData(customerName, invoiceNo) {

            var tableDocument =$('#table_invoice').DataTable({
                "bJQueryUI": true,
                "destroy": true,
                "bProcessing": true,
                "deferRender": true,
                "bFilter": true,
                "bInfo": true,
                "paging": true,
                "autoWidth": false,
                "ordering": false,
                "sAjaxSource": '/home/getlistinvoice?customerName=' + customerName + '&invoiceNo=' + invoiceNo,
                "sAjaxDataProp": "",
                "aoColumns": [
                    {
                        "mData": function (data, row) {
                            return '<a class="btn btn-default edit-status-ethnic" href="javascript:;"> View Invoice</a>' +
                                '<a class="btn btn-default edit-status-ethnic" href="javascript:;"> Input Collection</a>' +
                                '<a class="btn btn-default edit-status-ethnic" href="javascript:;"> Cancel Invoice</a>';
                            

                        }
                    },
                    { "mDataProp": "invoiceNo"},
                    { "mDataProp": "customerName" },
                    { "mDataProp": "invoiceDate" },
                    { "mDataProp": "dueDate" },
                    { "mDataProp": "currency" },
                    { "mDataProp": "invoiceAmmountIdr" },
                    { "mDataProp": "openAmmountIdr" },
                    { "mDataProp": "remark" }
                ]
            });

        };

        /* INIT TABLE CUSTOMER */
        function initCustomer() {

            var tableDocument = $('#table_ethnic').DataTable({
                "bJQueryUI": true,
                "destroy": true,
                "bProcessing": true,
                "deferRender": true,
                "bFilter": true,
                "bInfo": true,
                "paging": true,
                "autoWidth": false,
                "ordering": false,
                "sAjaxSource": '/home/getlistcustomer',
                "sAjaxDataProp": "",
                "aoColumns": [
                    { "mDataProp": "customerId", "visible": false, "searchable": true, "targets": [0] },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                    { "mDataProp": "customerName" },
                ]
            });

        };

        initData("", "");

        /* BTN MODAL INVOICE */
        $(document).on('click', '#btn-add-invoice', function (e) {

            $('#form_invoice')[0].reset();
            GetListCustomer();
            GetListCurrency();
            
        });

        // GET CUSTOMER NAME
        function GetListCustomer() {
            $.ajax({
                type: "GET",
                url: "/home/getlistcustomer",
                success: function (result) {
                    $('#txtCustomerName').html('<option value="">Customer ID - Customer Name </option>');
                    $.each(result, function (i) {
                        $('#txtCustomerName').append('<option value=' + this.customerId + '>' + this.customerId + ' - ' + this.customerName + '</option>');
                        if (i == (result.length - 1)) {
                            $('#modal-invoice').modal('show');
                        }
                    });
                },
                error: function (e) {
                    swal("Error!", "", "error");
                }
            });
        }

        // GET CUSTOMER NAME
        function GetListCurrency() {
            $.ajax({
                type: "GET",
                url: "/home/getlistcurrency",
                success: function (result) {
                    $('#txtCurrency').html('<option value="">Currency </option>');
                    $.each(result, function (i) {
                        $('#txtCurrency').append('<option value=' + this + '>' + this + '</option>');
                        if (i == (result.length - 1)) {
                            $('#txtCurrency').append('<option value=IDR> IDR </option>');
                        }
                    });
                },
                error: function (e) {
                    swal("Error!", "", "error");
                }
            });
        }

        // SET INVOICE INFO
        function SetInvoiceInfo(id) {
            $.ajax({
                type: "GET",
                url: "/home/setinvoiceinfo?id=" + id,
                success: function (result) {
                    $('#txtInvoiceNo').val(result.invoiceNo);
                    $('#txtInvoiceDate').val(result.invoiceDate);
                    $('#txtDueDate').val(result.dueDate);
                },
                error: function (e) {
                    swal("Error!", "", "error");
                }
            });
        }

        // GET CURRENCY RATE
        function GetCurrencyRate(id) {
            $.ajax({
                type: "GET",
                url: "/home/getcurrencyrate?id=" + id,
                success: function (result) {
                    $('#txtRate').val(formatCurrency(result));
                },
                error: function (e) {
                    swal("Error!", "", "error");
                }
            });
        }

        /* SELECT CUSTOMER TO GET INVOICE INFO */
        $(document).on('change', '#txtCustomerName', function (e) {
            SetInvoiceInfo($(this).val());
        });

        /* SELECT CURRENCY */
        $(document).on('change', '#txtCurrency', function (e) {
            if ($(this).val() == 'IDR') {
                $('#txtRate').val(1);
            }
            else {
                GetCurrencyRate($(this).val());
            }
        });

        /* SUBMIT INVOICE */
        function SubmitInvoice() {
            var invoiceAmmountIdr;
            var invoiceAmmountForeign;
           
            var invoiceDto = new FormData();
            invoiceDto.append('invoiceNo', $('#txtInvoiceNo').val());
            invoiceDto.append('customerId', $('#txtCustomerName').val());
            invoiceDto.append('invoiceDate', $('#txtInvoiceDate').val());
            invoiceDto.append('dueDate', $('#txtDueDate').val());
            invoiceDto.append('currency', $('#txtCurrency').val());
            invoiceDto.append('rate', $('#txtRate').val());
            var ammount = parseFloat($('#txtInvoiceAmmount').val().replace(',', ''));
            

            if ($('#txtCurrency').val() == 'USD') {
                invoiceAmmountIdr = ammount * parseInt($('#txtRate').val().replace(',', ''));
                invoiceDto.append('invoiceAmmountIDR', formatCurrency(parseFloat(invoiceAmmountIdr).toFixed(2)));
                invoiceDto.append('openAmmountIDR', formatCurrency(parseFloat(invoiceAmmountIdr).toFixed(2)));
                invoiceDto.append('invoiceAmmountForeign', ammount);
                invoiceDto.append('openAmmountForeign', ammount);
                invoiceDto.append('remark', $('#txtRemark').val());
                invoiceDto.append('isActive', 1);
                //alert(formatCurrency(parseFloat(invoiceAmmountIdr).toFixed(2))); //
            }
            else
            {
                invoiceDto.append('invoiceAmmountIDR', $('#txtInvoiceAmmount').val());
                invoiceDto.append('openAmmountIDR', $('#txtInvoiceAmmount').val());
                invoiceDto.append('invoiceAmmountForeign', '0.00');
                invoiceDto.append('openAmmountForeign', '0.00');
                invoiceDto.append('remark', $('#txtRemark').val());
                invoiceDto.append('isActive', 1);
            }

            $.ajax({
                type: "POST",
                url: "/home/submitinvoice",
                data: invoiceDto,
                contentType: false,
                processData: false,
                success: function (result) {
                    App.unblockUI();
                    if (result == true) {
                        swal({
                            title: "Berhasil Disimpan",
                            text: "Data Berhasil disimpan",
                            type: "success"
                        }, function () {
                            initData('', '');
                            $('#modal-invoice').modal('hide');
                        });
                    }
                    else {
                        swal({
                            title: "Gagal Disimpan",
                            text: "Data Gagal disimpan",
                            type: "error"
                        }, function () {
                            initData('', '');
                        });
                    }
                },
                error: function (e) {
                    swal("Error!", "", "error");
                }
            });

        }
        
        /* BTN MODAL INVOICE */
        $(document).on('click', '#btn-submit-invoice', function (e) {
            SubmitInvoice();
        });

        $(".number-only").keydown(function (e) {
            // Allow: backspace, delete, tab, escape, enter and .
            if ($.inArray(e.keyCode, [46, 8, 9, 27, 13, 110, 190]) !== -1 ||
                // Allow: Ctrl+A, Command+A
                (e.keyCode === 65 && (e.ctrlKey === true || e.metaKey === true)) ||
                // Allow: home, end, left, right, down, up
                (e.keyCode >= 35 && e.keyCode <= 40)) {
                // let it happen, don't do anything
                return;
            }
            // Ensure that it is a number and stop the keypress
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && (e.keyCode < 96 || e.keyCode > 105)) {
                e.preventDefault();
            }
        });

        $(".number-only").keyup(function (e) {
            var val = this.value;
            val = val.replace(/[^0-9\.]/g, '');

            if (val != "") {
                valArr = val.split('.');
                valArr[0] = (parseInt(valArr[0], 10)).toLocaleString();
                val = valArr.join('.');
            }

            this.value = val;
        });

        function formatCurrency(value) {
            var val = value;
            val = value.replace(/[^0-9\.]/g, '');

            if (val != "") {
                valArr = val.split('.');
                valArr[0] = (parseInt(valArr[0], 10)).toLocaleString();
                val = valArr.join('.');
            }

            return val;
        }

    });
</script>